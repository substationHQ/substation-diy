<!doctype html>
<html class="no-js" lang="">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{{copy.title}}</title>
  <meta name="description" content="{{copy.description}}">
  <meta name="author" content="@jessevondoom">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" type="text/css" href="/normalize.css">
  <link rel="stylesheet" type="text/css" href="/skeleton.css">
  <link rel="stylesheet" type="text/css" href="/custom.css">
  <link rel="stylesheet" type="text/css" href="/dashboard.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="https://cdn.glitch.com/9f35da85-6537-4c08-8c75-92364571d412%2Flogo-bw-email.png?v=1579197689402">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/substation-me/lodge@0.1/source/lodge.js" data-options="noembed"></script>
  
  <!-- Include Quill stylesheet -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style type="text/css">
    #subject {width:100%;}
    #mailing-editor {border-radius:0 0 4px 4px;background-color:#fff;}
    .ql-toolbar {border-radius:4px 4px 0 0;}
  </style>
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->

  <div class="section hero">
    <div class="container">
      <div class="row">
        <h1>
          Mail all current members
        </h1>
        <h2>
          SUBSTATION <span class="diy"><a href="/dashboard">DASHBOARD</a>: MAILING</span> <span class="logo">///</span>
        </h2>
      </div>
    </div>
  </div>
  
  <div class="section more">
    <div class="container">
      <div class="row">
        <div class="two columns">&nbsp;</div>
        <div class="eight columns">
          {{#showadmin}}
            <p>
              Write a message and send a test to yourself to unlock the "send to all" button. If 
              the test looks good then let it fly. 
            </p>
          
            <form id="admin-mailing" action="./mailing" method="POST" enctype="multipart/form-data">
              <input type="text" placeholder="Email subject" id="subject" name="subject">
          
              <!-- Create the Quill editor container -->
              <div id="mailing-editor"></div>
              
              <br><br>
              <input type="hidden" name="contents" />
              <input type="hidden" name="sending" />
              <input type="button" id="mailing-test" value="Send a test to yourself" /> <input type="button" id="mailing-send" value="Send to all subscribers" disabled />
            </form>

            <!-- Include the Quill library -->
            <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

            <!-- Initialize Quill editor -->
            <script>
              var toolbarOptions = [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'align': [] }], [{ 'color': [] }, { 'background': [] }], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image']];
              var quill = new Quill('#mailing-editor', {
                theme: 'snow',
                modules: {
                  toolbar: toolbarOptions
                }
              });
            </script>
          
            <!-- Include jQuery -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
            <script>
              var form = document.querySelector('#admin-mailing');
              var testbutton = document.querySelector('#mailing-test');
              var sendbutton = document.querySelector('#mailing-send');
              testbutton.onclick = function(e) {
                initiateMailing('Check your inbox for a test email.');
                sendbutton.disabled = false;
                e.preventDefault();
                return false;
              };
              sendbutton.onclick = function(e) {
                document.querySelector('input[name=sending]').value = 'true';
                initiateMailing('Well. That\'s been sent out to all your subscribers.');
                //form.style.visibility = 'hidden';
                e.preventDefault();
                return false;
              };
              form.onsubmit = function(e) {
                e.preventDefault();
                return false;
              };
              
              function initiateMailing(successMessage) {
                document.querySelector('input[name=contents]').value = quill.root.innerHTML;
                
                var vv = window.lodge;
                var poststring = 'subject='+encodeURIComponent(document.querySelector('input[name=subject]').value);
                poststring += '&contents='+encodeURIComponent(document.querySelector('input[name=contents]').value);
                poststring += '&sending='+encodeURIComponent(document.querySelector('input[name=sending]').value);
                
                vv.ajax.send('./mailing', poststring, function(r) {
                  if (r == 'OK') {
                    vv.overlay.reveal('<h2 class="vv-checkout-success">'+successMessage+'</h2>');
                  } else {
                    vv.overlay.reveal('<h2 class="vv-checkout-error">Something went wrong. Please reload the page and try again.</h2>');
                  }
                });
              }
            </script>
          {{/showadmin}}
          {{^showadmin}}
            {{^postsend}}
              <form id="admin-login" action="/dashboard" method="GET">
                <input type="email" placeholder="admin@email.com" name="email">
                <input type="submit" value="Log in now" />
              </form>
            {{/postsend}}
            {{#postsend}}
              <p>
                Check your inbox. We just sent a secure single-use link to your dashboard.
              </p>
            {{/postsend}}
          {{/showadmin}}
        </div>
        <div class="two columns">&nbsp;</div>
      </div>
    </div>
  </div>
  
  <div class="section footer">
    <div class="container">
      
      <div class="row">
        <div class="corner">
          <h1>
            <span class="logo">///</span>
          </h1>
        </div>
      </div>
    </div>
  </div>
  
<!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
</body>
</html>